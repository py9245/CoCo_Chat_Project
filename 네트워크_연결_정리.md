# GitHub Pages 프런트 ↔ EC2 백엔드 네트워크 정리

현재 구성은 **정적 프런트( GitHub Pages )**와 **동적 백엔드(EC2의 Docker/nginx/Django)**가 서로 다른 네트워크 영역에 있으나, 브라우저가 두 자원을 모두 사용하도록 설계돼 있습니다. 아래는 필요한 네트워크 요소와 흐름입니다.

---

## 1. 보안 그룹 규칙
| 프로토콜 | 포트 | 소스 | 용도 |
|----------|------|------|------|
| TCP      | 80   | 0.0.0.0/0 | Let’s Encrypt HTTP-01 검증, HTTPS로 리다이렉트 |
| TCP      | 443  | 0.0.0.0/0 | 실제 사용자 트래픽(nginx → Django API/정적 파일) |
| TCP      | 22   | 팀원 3인의 고정 IP | SSH 접속(배포/점검) |

- HTTP/HTTPS 전체 오픈은 외부 사용자를 받아야 하므로 필수입니다.
- SSH는 팀원의 고정 IP만 허용해 보안을 유지합니다.

---

## 2. 요청 흐름
1. 사용자가 `https://<username>.github.io` 접속
2. GitHub Pages CDN이 SPA 정적 파일(`index.html`, JS, CSS, 이미지)을 전달
3. JS가 실행되며 `window.location.hostname`/`window.API_BASE_URL`/`VITE_API_BASE_URL` 등을 기준으로 API 기본 도메인을 계산
4. 브라우저가 `https://3-37-130-181.nip.io/api/...` (또는 커스텀 도메인)로 REST 요청 전송
5. DNS가 `3-37-130-181.nip.io`를 EC2 공인 IP로 해석
6. 사용자의 HTTPS 요청이 EC2 보안 그룹을 통과 → 호스트 OS → Docker `nginx` 컨테이너 443 포트
7. nginx가 `/api/*`를 Gunicorn(Django)로 프록시, `/` 는 `frontend_build` 정적 파일을 반환
8. Django가 CORS/Trusted Origins 검사를 통과한 요청만 응답하여 다시 사용자 브라우저로 전달

---

## 3. CORS·도메인 관련 설정
- **DNS**: `3-37-130-181.nip.io`는 nip.io 와일드카드로 EC2 공인 IP에 자동 매핑됩니다. 커스텀 도메인을 쓰려면 Route53 또는 외부 DNS에서 A/AAAA/CNAME 레코드를 설정하세요.
- **nginx**: `proxy_pass http://backend:8000;` 형태로 Docker 네트워크 내부에서 Django 컨테이너와 통신합니다.
- **Django**:
  - `DJANGO_ALLOWED_HOSTS`에 EC2 도메인, nip.io, localhost 등을 포함
  - `DJANGO_TRUSTED_ORIGINS`에 HTTPS 기원(origin) 명시
  - `CORS_ALLOWED_ORIGINS`에 GitHub Pages 도메인(`https://<username>.github.io`) 추가
- **프런트**:
  - 개발 중에는 `VITE_API_PROXY_TARGET=http://localhost:8000` 등으로 프록시
  - 배포 시 `VITE_API_BASE_URL=https://3-37-130-181.nip.io/api` 또는 `window.API_BASE_URL` 전역 주입

이렇게 하면 GitHub Pages가 다른 도메인에 있더라도 브라우저가 백엔드 요청을 정상적으로 보내고, Django가 신뢰된 출처만 허용합니다.

---

## 4. HTTPS / 인증서
- Let’s Encrypt HTTP-01 챌린지를 위해 80 포트가 잠시 사용되므로 반드시 열어 둡니다.
- 인증서 파일(`/etc/letsencrypt/live/...`)을 `/home/ubuntu/app/certs`로 링크 후 `docker-compose.yml`에서 nginx 컨테이너에 마운트합니다.
- GitHub Pages는 기본적으로 GitHub이 발급한 TLS 인증서를 사용하므로 별도 작업이 필요 없습니다.

---

## 5. 추가 고려 사항
- **IP 제한**: 관리자용 API 등에 대해선 nginx에서 추가 IP 화이트리스트를 둘 수 있습니다.
- **WAF/ALB**: 대규모 트래픽 시 AWS ALB + WAF 앞단을 두고 EC2를 Target 으로 등록하는 구조로 확장 가능합니다.
- **로그/모니터링**: nginx 접근 로그(EC2)와 GitHub Pages Insights로 양쪽 트래픽을 모두 관찰합니다.

이 구조 덕분에 정적 리소스는 GitHub CDN에서 빠르게 배포되고, 민감한 API는 EC2에서 제어된 보안그룹 하에 운영됩니다.
